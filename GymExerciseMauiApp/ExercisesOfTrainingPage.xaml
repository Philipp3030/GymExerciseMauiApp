<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="GymExerciseMauiApp.ExercisesOfTrainingPage"
             xmlns:viewmodel="clr-namespace:GymExerciseClassLibrary.ViewModels;assembly=GymExerciseClassLibrary"
             x:DataType="viewmodel:ExercisesOfTrainingViewModel"
             Title="ExercisesOfTraining">
    <Grid Padding="20">
        <Grid.GestureRecognizers>
            <TapGestureRecognizer Tapped="HideKeyboardAndUnfocus"/>
        </Grid.GestureRecognizers>
        <Entry x:Name="FocusStealer"
                WidthRequest="100" HeightRequest="10"
                Opacity="0"
               BackgroundColor="red"
                IsEnabled="True">
        </Entry>

        <CollectionView ItemsSource="{Binding Training.ExercisesOfTraining}" x:Name="ExerciseCollectionView">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="viewmodel:ExerciseViewModel">
                    <VerticalStackLayout Margin="0, 10, 0, 0">
                        <Border>
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="10" />
                            </Border.StrokeShape>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition/>
                                    <RowDefinition/>
                                </Grid.RowDefinitions>
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Tapped="HideKeyboardAndUnfocus"/>
                                </Grid.GestureRecognizers>

                                <!-- Header Area (Always Visible) -->
                                <Grid BackgroundColor="#E0E0E0" Padding="15" Grid.Row="0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="10"/>
                                    </Grid.RowDefinitions>
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExercisesOfTrainingViewModel}}, Path=ToggleExpandCommand}"
                                            CommandParameter="{Binding .}"/>
                                    </Grid.GestureRecognizers>

                                    <Entry Text="{Binding Name}" 
                                           x:Name="NameEntry"
                                           WidthRequest="200" 
                                           HeightRequest="44" 
                                           Margin="0,0,0,0" 
                                           FontAttributes="Bold"
                                           FontSize="16" 
                                           VerticalOptions="Center"
                                           InputTransparent="{Binding NameEntryInputTransparent}"
                                           IsReadOnly="{Binding NameEntryIsReadOnly}"
                                           BackgroundColor="#D0D0D0"
                                           Grid.Row="0"
                                           Unfocused="TriggerOnUnfocused">
                                        <Entry.Clip>
                                            <RectangleGeometry x:Name="NameEntryClip" Rect="4,10,150,24"/>
                                        </Entry.Clip>
                                    </Entry>

                                    <Entry Text="{Binding MachineName}" 
                                           x:Name="MachineEntry"
                                           Placeholder="Machine"
                                           WidthRequest="200" 
                                           HeightRequest="44" 
                                           FontAttributes="None"
                                           FontSize="14" 
                                           VerticalOptions="Center"
                                           InputTransparent="False"
                                           IsReadOnly="False"
                                           BackgroundColor="Transparent"
                                           Grid.Column="0"
                                           Grid.Row="1"
                                           Focused="OnChangeClipClicked"
                                           Unfocused="TriggerOnUnfocused">
                                        <Entry.Clip>
                                            <RectangleGeometry x:Name="MachineEntryClip" Rect="4,10,150,24"/>
                                        </Entry.Clip>
                                    </Entry>

                                    <!-- Stift Icon für Namen umbenennen -->
                                    <!--<Button Text="Edit" FontSize="14" TextColor="Gray" Grid.Column="1"
                                            VerticalOptions="Center" BackgroundColor="Transparent"
                                            Grid.RowSpan="2"
                                            Clicked="OnChangeClipClicked"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExercisesOfTrainingViewModel}}, Path=SetNameEntryToEditableCommand}" 
                                            CommandParameter="{Binding .}">
                                    </Button>-->
                                </Grid>

                                <!-- Expandable Area -->
                                <VerticalStackLayout x:Name="ExpandableArea" 
                                                BackgroundColor="#F7F7F7" 
                                                Padding="15"
                                                IsVisible="{Binding IsExpanded}"
                                                Spacing="10"
                                                Grid.Row="1">

                                    <!-- Sets Section -->
                                    <HorizontalStackLayout>
                                        <Label Text="Sätze: " FontSize="14" Margin="0,0,10,0" HorizontalTextAlignment="Center" VerticalOptions="Center" />
                                        <Label Text="{Binding AmountOfSets}" WidthRequest="50" 
                                                HorizontalTextAlignment="Center" VerticalOptions="Center" />
                                        <Button Text="+" 
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExercisesOfTrainingViewModel}}, Path=AddSetCommand}"
                                                CommandParameter="{Binding .}" />
                                    </HorizontalStackLayout>

                                    <!-- Set Collection -->
                                    <CollectionView x:Name="SetsCollectionView" ItemsSource="{Binding Sets}">
                                        <CollectionView.ItemTemplate>
                                            <DataTemplate x:DataType="viewmodel:SetViewModel">
                                                <HorizontalStackLayout Spacing="10">
                                                    <Button Text="—" 
                                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExercisesOfTrainingViewModel}}, Path=RemoveSetCommand}"
                                                            CommandParameter="{Binding .}"
                                                            WidthRequest="40"
                                                            HeightRequest="40"
                                                            CornerRadius="20"
                                                            HorizontalOptions="Center"
                                                            VerticalOptions="Center"
                                                            >
                                                    </Button>

                                                    <Label Text="{Binding Index, StringFormat='Reps:'}"
                                                            VerticalOptions="Center" />

                                                    <!-- Reps Input -->
                                                    <VerticalStackLayout>
                                                        <Entry WidthRequest="50" 
                                                               Placeholder="Reps" 
                                                               Keyboard="Numeric"
                                                               Text="{Binding Reps}" 
                                                               HorizontalTextAlignment="Center"
                                                               Focused="Entry_Focused"
                                                               Unfocused="TriggerOnUnfocused">
                                                        </Entry>
                                                        <Label Text="{Binding ErrorMessageReps}" TextColor="Red" IsVisible="True" />
                                                    </VerticalStackLayout>

                                                    <!-- Weight Input -->
                                                    <Label Text="Weight:" VerticalOptions="Center" />

                                                    <VerticalStackLayout>
                                                        <Entry WidthRequest="75" 
                                                               Placeholder="Weight" 
                                                               Keyboard="Numeric"
                                                               Text="{Binding Weight}" 
                                                               HorizontalTextAlignment="Center"
                                                               Focused="Entry_Focused"
                                                               Unfocused="TriggerOnUnfocused"/>
                                                        <Label Text="{Binding ErrorMessageWeight}" TextColor="Red" IsVisible="True" />
                                                        <!--Location => decimal dots / commas-->
                                                    </VerticalStackLayout>
                                                </HorizontalStackLayout>
                                            </DataTemplate>
                                        </CollectionView.ItemTemplate>
                                    </CollectionView>

                                    <!-- Advanced Options Button -->
                                    <Button Text="Advanced Options" 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:ExercisesOfTrainingViewModel}}, Path=ToggleAdvancedOptionsCommand}"
                                            CommandParameter="{Binding .}">
                                    </Button>

                                    <!-- Advanced Fields -->
                                    <VerticalStackLayout IsVisible="{Binding IsAdvancedOptionsClicked}">
                                        <Label Text="Maschine:" FontSize="14" TextColor="Gray" />
                                        <Entry Text="{Binding MachineName}" FontSize="14" TextColor="Gray" />
                                    </VerticalStackLayout>
                                </VerticalStackLayout>
                            </Grid>
                        </Border>
                    </VerticalStackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>